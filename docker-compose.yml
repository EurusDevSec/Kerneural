version: '3.8'

services:
  #1. The victim
  victim:
    image: nginx:latest
    container_name: victim
    ports:
      - "8080:80"
    volumes:
      - ./tmp_victim:/tmp_data
    restart: always
  
  #2. The Blue Agent (Falco Sensor)
  falco:
    image: falcosecurity/falco:latest
    container_name: falco
    privileged: true
    pid: "host"
    ipc: "host"
    cap_add:
      - SYS_PTRACE
      - SYS_RESOURCE
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - /dev:/host/dev
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc:/host/etc:ro
      - /:/rootfs:ro
      - ./configs/falco.yaml:/etc/falco/falco.yaml
      - ./configs/falco_rules.local.yaml:/etc/falco/falco_rules.local.yaml
      - ./logs:/var/log/falco
    environment:
      - FALCO_K8S_AUDIT_ENDPOINT=false
      - HOST_ROOT=/host